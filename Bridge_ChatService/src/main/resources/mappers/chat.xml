<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.matchbridge.chat.mapper.ChatMapper">


  <!-- resultMap Ï∂îÍ∞Ä -->
  <resultMap id="chatResultMap" type="com.matchbridge.chat.dto.ChatDTO">
    <id property="id" column="id" />
    <result property="sender" column="sender" />
    <result property="receiver" column="receiver" />
    <result property="content" column="message" />
    <result property="timestamp" column="timestamp" />
  </resultMap>
  
  
  <!-- 1. Î©îÏãúÏßÄ Ï†ÄÏû• -->
  <insert id="saveMessage" parameterType="com.matchbridge.chat.dto.ChatDTO">
    INSERT INTO chat_message (sender, receiver, message)
    VALUES (#{sender}, #{receiver}, #{content})
  </insert>

  <!-- 2. Ï±ÑÌåÖ ÎÇ¥Ïó≠ Ï°∞Ìöå (ÏñëÎ∞©Ìñ•) -->
<select id="getMessages" resultMap="chatResultMap">
    SELECT *
    FROM chat_message
    WHERE (sender = #{myId} AND receiver = #{otherId})
       OR (sender = #{otherId} AND receiver = #{myId})
    ORDER BY timestamp ASC
</select>

  <resultMap id="recentChatResultMap" type="com.matchbridge.chat.dto.ChatDTO">
    <result property="id" column="id"/>
    <result property="otherId" column="otherId"/>
    <result property="username" column="username"/>
    <result property="age" column="age"/>
    <result property="home" column="home"/>
    <result property="imageUrl" column="imageUrl"/>
    <result property="lastMessage" column="lastMessage"/>
    <result property="lastMessageTime" column="lastMessageTime"/>
    <result property="unreadCount" column="unreadCount"/>
  </resultMap>
  
  <select id="getRecentSenders" parameterType="string" resultMap="recentChatResultMap">
    SELECT 
         m.id AS otherId,
        m.username,
        m.age,
        m.home,
        m.imageUrl,
        latest.message AS lastMessage,
        latest.timestamp AS lastMessageTime
       
    FROM member m
    JOIN (
        SELECT t.otherId, t.message, t.timestamp
        FROM (
            SELECT
                CASE 
                    WHEN sender = #{myId} THEN receiver
                    ELSE sender
                END AS otherId,
                message,
                timestamp,
                ROW_NUMBER() OVER (
                    PARTITION BY 
                        CASE 
                            WHEN sender = #{myId} THEN receiver
                            ELSE sender
                        END
                    ORDER BY timestamp DESC
                ) AS rn
            FROM chat_message
            WHERE sender = #{myId} OR receiver = #{myId}
        ) t
        WHERE t.rn = 1   -- üî• Í∞Å ÏÉÅÎåÄÎ∞©Î≥Ñ ÏµúÏã† Î©îÏãúÏßÄ 1Í∞úÎßå ÏÑ†ÌÉù
    ) latest ON m.id = latest.otherId
    ORDER BY latest.timestamp DESC;  -- ÏµúÏ¢ÖÏ†ÅÏúºÎ°ú ÏµúÏã†ÏàúÏúºÎ°ú Ï†ïÎ†¨
</select>

<update id="markMessagesAsRead">
    UPDATE chat_message
    SET read_status = 1
    WHERE receiver = #{myId}
      AND sender = #{otherId}
      AND read_status = 0;
</update>


<select id="countUnreadMessages" parameterType="string" resultType="int">
    SELECT COUNT(*)
    FROM chat_message
    WHERE receiver = #{myId}
      AND read_status = 0
</select>

<select id="countUnreadBySender" resultType="int">
    SELECT COUNT(*)
    FROM chat_message
    WHERE receiver = #{myId}
      AND sender = #{otherId}
      AND read_status = 0
</select>

  
 

  

</mapper>
