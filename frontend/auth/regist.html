<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>LoveBridge - íšŒì›ê°€ì…</title>
  <style>
      body {
         background-color: #ffeaf4;
         text-align: center;
         padding-top: 80px;
      }
      .form-wrapper {
         display: inline-block;
         background-color: #fff0f7;
         border: 4px dotted #ff6db3;
         border-radius: 30px;
         padding: 40px 50px;
         box-shadow: 0 0 20px #ffcce6;
      }
      h1 {
         color: #ff3399;
         margin-bottom: 30px;
      }
      input[type="text"],
      input[type="password"] {
         width: 250px;
         padding: 10px;
         margin: 8px 0;
         border: 2px solid #ffaad4;
         border-radius: 15px;
         background-color: #fff;
      }
      input::placeholder {
         color: #ff66a3;
      }
      .cute-button {
         display: inline-block;
         background: linear-gradient(to bottom, #ff80b5, #ff4d94);
         color: white;
         font-size: 18px;
         padding: 10px 24px;
         margin: 10px;
         border: 3px solid white;
         border-radius: 20px;
         box-shadow: 0 5px 15px rgba(255, 105, 180, 0.4);
         cursor: pointer;
         text-decoration: none;
         transition: all 0.2s ease;
      }
      .cute-button:hover {
         transform: scale(1.05);
         box-shadow: 0 8px 20px rgba(255, 105, 180, 0.6);
      }
      label {
         display: block;
         font-size: 14px;
         color: #ff66a3;
         margin-bottom: 5px;
      }
      select {
          width: 270px;
          padding: 10px;
          margin: 8px 0;
          border: 2px solid #ffaad4;
          border-radius: 15px;
          background-color: #fff;
          font-size: 16px;
          color: #ff3399;
          appearance: none;
          background-image: url('data:image/svg+xml;charset=US-ASCII,<svg xmlns="http://www.w3.org/2000/svg" width="4" height="5" viewBox="0 0 4 5"><path fill="%23ff66aa" d="M2 0L0 2h4L2 0z"/></svg>');
          background-repeat: no-repeat;
          background-position: right 12px center;
          background-size: 12px;
      }
  </style>
</head>

<body>
  <div class="form-wrapper">
    <h1>ğŸ’Œ íšŒì›ê°€ì…</h1>

    <!-- ì„œë²„ redirect ê¸°ë°˜ msg ëŒ€ì‹ , JSì—ì„œ ì§ì ‘ ë©”ì‹œì§€ í‘œì‹œìš© -->
    <font color="red" id="msg"></font>

    <!-- ğŸ”¥ REST ë²„ì „: method / action ì œê±° (submit ì•ˆ ì”€) -->
    <form id="f" enctype="multipart/form-data" onsubmit="return false;">

      <input type="text" id="id" name="id" placeholder="ì•„ì´ë””" required><br>
      <label id="idCheckLabel" style="font-size: 13px;"></label>

      <input type="password" id="pw" name="pw" placeholder="ë¹„ë°€ë²ˆí˜¸" oninput="pwCheck()" required><br>
      <input type="password" id="confirm" name="confirm" placeholder="ë¹„ë°€ë²ˆí˜¸ í™•ì¸" onchange="pwCheck()" required><br>
      <label id="pwCheckLabel"></label>
      <label id="label"></label>

      <input type="text" id="username" name="username" placeholder="ì´ë¦„" required><br>
      <input type="text" id="mobile" name="mobile" placeholder="ì „í™”ë²ˆí˜¸" required><br>
      <input type="text" id="age" name="age" placeholder="ë‚˜ì´" required><br>
      <input type="text" id="home" name="home" placeholder="ê±°ì£¼ì§€(ì˜ˆ:ì„œìš¸)" required><br>

      <select name="gender" id="gender" required>
        <option value="">ì„±ë³„ ì„ íƒ</option>
        <option value="ë‚¨ì„±">ë‚¨</option>
        <option value="ì—¬ì„±">ì—¬</option>
      </select><br>

      <!-- íŒŒì¼ ì—…ë¡œë“œ(ìˆ¨ê¹€) + ì»¤ìŠ¤í…€ ë²„íŠ¼ -->
      <input type="file" id="imageFile" name="imageFile" accept="image/*" style="display:none;">
      <button type="button" id="customFileBtn" class="cute-button">í”„ë¡œí•„ì´ë¯¸ì§€ ë“±ë¡</button><br>

      <img id="preview" src="" alt="ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸°"
           style="max-width: 200px; margin-top: 10px; display: none;"><br><br>

      <!-- âœ… ì´ì œ form.submit()ì´ ì•„ë‹ˆë¼ JS í•¨ìˆ˜ì—ì„œ REST í˜¸ì¶œ í›„ í˜ì´ì§€ ì´ë™ -->
      <input type="button" value="ë‹¤ìŒ" class="cute-button" onclick="goProfile()">
      <input type="button" value="ì·¨ì†Œ" class="cute-button" onclick="cancelJoin()"><br>
    </form>
  </div>

  <script>
    // ==============================
    // ì „ì—­ ìƒíƒœ
    // ==============================
    let isDuplicateId = false;

    // ==============================
    // onload: sessionStorageì—ì„œ ê°’ ë³µì›
    // ==============================
    window.onload = function () {
      const isNavigated = sessionStorage.getItem('navigated') === 'true';

      if (!isNavigated) {
        sessionStorage.clear();
      }

      const fields = ['id', 'pw', 'confirm', 'username', 'mobile', 'age', 'home'];
      fields.forEach(field => {
        const value = sessionStorage.getItem(field);
        if (value !== null) {
          const input = document.getElementById(field);
          if (input) input.value = value;
        }
      });

      const gender = sessionStorage.getItem('gender');
      if (gender !== null) {
        document.getElementById('gender').value = gender;
      }

      const storedImageUrl = sessionStorage.getItem('imageUrl');
      if (storedImageUrl) {
        const preview = document.getElementById('preview');
        preview.src = storedImageUrl;
        preview.style.display = "block";
      }
    };

    // ==============================
    // í”„ë¡œí•„ ì´ë¯¸ì§€ ë²„íŠ¼ â†’ ìˆ¨ê²¨ì§„ input í´ë¦­
    // ==============================
    document.getElementById("customFileBtn").addEventListener("click", function() {
      document.getElementById("imageFile").click();
    });

    // ==============================
    // ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸° (ë¡œì»¬)
    // ==============================
    document.getElementById("imageFile").addEventListener("change", function () {
      const file = this.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function (e) {
          const preview = document.getElementById("preview");
          preview.src = e.target.result;
          preview.style.display = "block";
        };
        reader.readAsDataURL(file);
      }
    });

    // ==============================
    // ë¹„ë°€ë²ˆí˜¸ ì²´í¬
    // ==============================
    function pwCheck() {
      const pw = document.getElementById("pw").value;
      const confirm = document.getElementById("confirm").value;
      const label = document.getElementById("label");
      if (pw.length < 5) {
        label.innerText = "ë¹„ë°€ë²ˆí˜¸ëŠ” 5ìë¦¬ ì´ìƒ ì…ë ¥í•˜ì„¸ìš”.";
        label.style.color = "red";
      } else if (pw !== confirm) {
        label.innerText = "ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.";
        label.style.color = "red";
      } else {
        label.innerText = "ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•©ë‹ˆë‹¤!";
        label.style.color = "green";
      }
    }

    // ==============================
    // ì•„ì´ë”” ì¤‘ë³µì²´í¬ (REST) - /api/auth/check-id
    // ==============================
    document.getElementById("id").addEventListener("blur", function () {
      const id = this.value.trim();
      if (!id) return;

      fetch("/api/auth/check-id?id=" + encodeURIComponent(id))
        .then(response => response.json())
        .then(result => {
          const label = document.getElementById("idCheckLabel");
          if (result.duplicate) {
            label.innerText = "ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ì•„ì´ë””ì…ë‹ˆë‹¤.";
            label.style.color = "red";
            isDuplicateId = true;
          } else {
            label.innerText = "ì‚¬ìš© ê°€ëŠ¥í•œ ì•„ì´ë””ì…ë‹ˆë‹¤!";
            label.style.color = "green";
            isDuplicateId = false;
          }
        })
        .catch(err => {
          console.error(err);
          document.getElementById("idCheckLabel").innerText = "ì¤‘ë³µì²´í¬ ì¤‘ ì˜¤ë¥˜ ë°œìƒ";
          document.getElementById("idCheckLabel").style.color = "red";
        });
    });

    // ==============================
    // ë‹¤ìŒ ë‹¨ê³„ë¡œ ì´ë™: ê¸°ë³¸ì •ë³´ + (í•„ìš” ì‹œ) ì´ë¯¸ì§€ ì—…ë¡œë“œ
    // ==============================
    async function goProfile() {
      const form = document.getElementById("f");
      const data = new FormData(form);

      const pw = data.get("pw");
      const confirm = data.get("confirm");

      if (isDuplicateId) {
        alert("ì•„ì´ë””ë¥¼ ë‹¤ì‹œ í™•ì¸í•˜ì„¸ìš”.");
        return;
      }

      if (!pw || !confirm || pw !== confirm) {
        alert("ë¹„ë°€ë²ˆí˜¸ë¥¼ ë‹¤ì‹œ í™•ì¸í•´ì£¼ì„¸ìš”.");
        return;
      }

      // ë¬¸ìì—´ í•„ë“œ ë¹ˆ ê°’ ì²´í¬ (íŒŒì¼ ì œì™¸)
      for (const [key, value] of data.entries()) {
        if (value instanceof File) continue; // imageFileì€ ì—¬ê¸°ì„œ ê²€ì‚¬ ì•ˆ í•¨
        if (typeof value === "string" && !value.trim()) {
          alert("ëª¨ë“  í•­ëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
          return;
        }
      }

      // ============================
      // 1) (í•„ìš” ì‹œ) í”„ë¡œí•„ ì´ë¯¸ì§€ ì—…ë¡œë“œ
      // ============================
      let imageUrl = sessionStorage.getItem("imageUrl") || "";
      const imageFile = document.getElementById("imageFile").files[0];

      // ìƒˆë¡œ ì„ íƒí•œ íŒŒì¼ì´ ìˆìœ¼ë©´ ì—…ë¡œë“œ
      if (imageFile) {
        try {
          const uploadForm = new FormData();
          uploadForm.append("imageFile", imageFile);

          const res = await fetch("/api/auth/profile/image", {
            method: "POST",
            body: uploadForm
          });

          if (!res.ok) {
            const errJson = await res.json().catch(() => ({}));
            const msg = errJson.message || "ì´ë¯¸ì§€ ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.";
            alert(msg);
            return;
          }

          const json = await res.json();
          imageUrl = json.imageUrl;
          sessionStorage.setItem("imageUrl", imageUrl);
        } catch (e) {
          console.error(e);
          alert("ì´ë¯¸ì§€ ì—…ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
          return;
        }
      }

      // ============================
      // 2) ë¬¸ìì—´ ê°’ë“¤ì„ sessionStorageì— ì €ì¥
      // ============================
      for (const [key, value] of data.entries()) {
        if (value instanceof File) continue;  // íŒŒì¼ ì œì™¸
        if (typeof value === "string") {
          sessionStorage.setItem(key, value);
        }
      }

      if (imageUrl) {
        sessionStorage.setItem("imageUrl", imageUrl);
      }

      sessionStorage.setItem('navigated', 'true');

      // ============================
      // 3) ë‹¤ìŒ ë‹¨ê³„(ë‚´ í”„ë¡œí•„ ì…ë ¥ í˜ì´ì§€)ë¡œ ì´ë™
      //    â†’ ì´ í˜ì´ì§€ì—ì„œëŠ” server-side viewë¡œ ê°€ì§€ ì•Šê³ ,
      //      ì •ì  profile.htmlë¡œ ë¼ìš°íŒ…í•œë‹¤ê³  ê°€ì •.
      // ============================
      location.href = "profile.html";
    }

    // ==============================
    // ê°€ì… ì·¨ì†Œ
    // ==============================
    function cancelJoin() {
      sessionStorage.clear();
      location.href = '../index.html'; // í•„ìš”í•˜ë©´ ê²½ë¡œ ì¡°ì •
    }
  </script>
</body>
</html>
